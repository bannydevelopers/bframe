<div class="flex">
    <h1 class="content-small no-pad-top">Tools</h1>
    <div class="shrink" style="white-space: nowrap;text-align: right;">
        <button onclick="add_tool()" value="add" data-form-width="wide" class="round">Add tool</button>
    </div>
</div>
<br>
<div>
    <div class="tab-view">
        <?php foreach(array_keys($sortedTool) as $i=>$k){?>
        <input type="radio" name="tab" id="class_tab<?=$i?>"<?=$i == 0?' checked':'' ?>>
        <label for="class_tab<?=$i?>"><?=$k?></label>
        <?php }?>
        <div class="tab-panes">
            <?php foreach($sortedTool as $k=>$toolx){?>
            <div class="white">
                <div class="tab-view" style="text-align: left; margin-top: 20px;">
                    <input type="radio" name="itab<?=$k?>" id="class_tab12<?=$k?>">
                    <label for="class_tab12<?=$k?>">Overview</label>
                    <input type="radio" name="itab<?=$k?>" id="class_tab22<?=$k?>" checked>
                    <label for="class_tab22<?=$k?>">Available (<?=intval(count($tools_available))?>)</label>
                    <input type="radio" name="itab<?=$k?>" id="class_tab23<?=$k?>">
                    <label for="class_tab23<?=$k?>">Borrowed (<?=intval(count($tools_borrowed))?>)</label>
                    <input type="radio" name="itab<?=$k?>" id="class_tab24<?=$k?>">
                    <label for="class_tab24<?=$k?>">Requested (<?=intval(count($tools_requests))?>)</label>
                    <input type="radio" name="itab<?=$k?>" id="class_tab25<?=$k?>">
                    <label for="class_tab25<?=$k?>">Off service (<?=intval(count($tools_offservice))?>)</label>
                    <div class="tab-panes" style="text-align: left;">

                        <div>Overview</div>
                        <div class="white content-small">
                            <table class="paginate" data-items-per-page="10">
                                <thead>
                                    <tr>
                                        <th>
                                            <input type="checkbox" onclick="upadte_checks()">
                                            Name
                                        </th>
                                        <th>
                                            Description
                                        </th>
                                        <th>
                                            Status
                                        </th>
                                        <th>
                                            &nbsp;
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <?php foreach($tools_available as $st){?>
                                    <tr data-json='<?=json_encode($st)?>'>
                                        <td class="flex" style="display: flex;">
                                            <input type="checkbox" name="tool_name[]" value="<?=$st['tool_name']?>" style="max-width:13px;max-height:13px">
                                            <span>
                                                &nbsp;<?=$st['tool_name']?>
                                            </span>
                                        </td>
                                        <td>
                                            <?=$st['tool_description']?><br>  
                                        </td>
                                        <td>
                                            <?=$st['tool_status']?><br>
                                            
                                        </td>
                                        <td>
                                            <a onclick="view_tool()" data-icon="&#xf06e;"></a>
                                            <a onclick="edit_tool()" data-icon="&#xf044;"></a>
                                            <a onclick="delete_tool()" data-icon="&#xf2ed;"></a>
                                        </td>
                                    </tr>
                                    <?php }?>
                                </tbody>
                            </table>
                        </div>
                        <div class="white content-small">
                            <table class="paginate" data-items-per-page="10">
                                <thead>
                                    <tr>
                                        <th>
                                            <input type="checkbox" onclick="upadte_checks()">
                                            Name
                                        </th>
                                        <th>
                                            Description
                                        </th>
                                        <th>
                                            Status
                                        </th>
                                        <th>
                                            &nbsp;
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <?php foreach($tools_borrowed as $st){?>
                                    <tr data-json='<?=json_encode($st)?>'>
                                        <td class="flex" style="display: flex;">
                                            <input type="checkbox" name="tool_name[]" value="<?=$st['tool_name']?>" style="max-width:13px;max-height:13px">
                                            <span>
                                                &nbsp;<?=$st['tool_name']?>
                                            </span>
                                        </td>
                                        <td>
                                            <?=$st['tool_description']?><br>  
                                        </td>
                                        <td>
                                            <?=$st['tool_status']?><br>
                                            
                                        </td>
                                        <td>
                                            <a onclick="view_tool()" data-icon="&#xf06e;"></a>
                                        </td>
                                    </tr>
                                    <?php }?>
                                </tbody>
                            </table>
                        </div>
                        <div class="white content-small">
                            <table class="paginate" data-items-per-page="10">
                                <thead>
                                    <tr>
                                        <th>
                                            <input type="checkbox" onclick="upadte_checks()">
                                            Name
                                        </th>
                                        <th>
                                            Description
                                        </th>
                                        <th>
                                            Status
                                        </th>
                                        <th>
                                            &nbsp;
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <?php foreach($tools_requests as $st){?>
                                    <tr data-json='<?=json_encode($st)?>'>
                                        <td class="flex" style="display: flex;">
                                            <input type="checkbox" name="tool_name[]" value="<?=$st['tool_name']?>" style="max-width:13px;max-height:13px">
                                            <span>
                                                &nbsp;<?=$st['tool_name']?>
                                            </span>
                                        </td>
                                        <td>
                                            <?=$st['tool_description']?><br>  
                                        </td>
                                        <td>
                                            <?=$st['tool_status']?><br>
                                            
                                        </td>
                                        <td>
                                            <a onclick="view_tool()" data-icon="&#xf06e;"></a>
                                        </td>
                                    </tr>
                                    <?php }?>
                                </tbody>
                            </table>
                        </div>
                        <div class="white content-small">
                            <table class="paginate" data-items-per-page="10">
                                <thead>
                                    <tr>
                                        <th>
                                            <input type="checkbox" onclick="upadte_checks()">
                                            Name
                                        </th>
                                        <th>
                                            Description
                                        </th>
                                        <th>
                                            Status
                                        </th>
                                        <th>
                                            &nbsp;
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <?php foreach($tools_offservice as $st){?>
                                    <tr data-json='<?=json_encode($st)?>'>
                                        <td class="flex" style="display: flex;">
                                            <input type="checkbox" name="tool_name[]" value="<?=$st['tool_name']?>" style="max-width:13px;max-height:13px">
                                            <span>
                                                &nbsp;<?=$st['tool_name']?>
                                            </span>
                                        </td>
                                        <td>
                                            <?=$st['tool_description']?><br>  
                                        </td>
                                        <td>
                                            <?=$st['tool_status']?><br>
                                            
                                        </td>
                                        <td>
                                            <a onclick="view_tool()" data-icon="&#xf06e;"></a>
                                        </td>
                                    </tr>
                                    <?php }?>
                                </tbody>
                            </table>
                        </div>
                        <!---->
                    </div>
                </div>
            </div>
            <?php } ?>
        </div>
    </div>
</div>
<style>.swal2-html-container{overflow: visible;}</style>
<template>
    <div class="vspaced" style="text-align: left;">
        <div class="flex white rounded" style="box-shadow: 0 0 4px #999;margin: 4px;margin-top: -4em;">
            <div class="content-small">
                <h3 style="padding-bottom: .6em;" class="large-text">{{tool_name}}</h3>
                <div><span style="color: rgb(35, 57, 136);">Description: </span>{{tool_email}}</div>
                <div><span style="color: rgb(35, 57, 136);">Status: </span>{{tool_phone_number}}</div>
            </div>
        </div>
    </div>
    <?php include __DIR__.'/add_tool.html';?>
    <form method="post" enctype="multipart/form-data">
        <label>CSV file</label>
        <input type="file" name="tool_list" accept=".csv" required>
        <div style="text-align: right;padding-top: 1em;">
            <button type="submit">Save</button>
        </div>
    </form>
</template>
<style>
    .mySwalForm{
        min-width: 80%;
    }
    .mySwalForm label, .mySwalSmallForm label{
        display: block;
        text-align: left;
        padding-left: 1em;
    }
    .mySwalSmallForm label{
        padding-left: 0;
    }
</style>
<style>
    .contentx{
        padding: 0 1em;
        flex-basis: 100%;
    }
    .contentx > *{
        flex-basis: 100%;
    }
    .contentx input,.contentx select{
        border:1px solid #eee;
        width: calc( 100% - 1.8em );
        margin-top: 6px;
    }
    .contentx label{
        padding-top: .8em;
    }
    .contentx option{
        line-height: 1.5em;
    }
    button{
        text-transform: uppercase;
        white-space: nowrap;
    }
    .flex > *{
        flex-basis: 100%;
    }
    .vspaced *{
        line-height: 1.2;
    }
    .large-text{
        font-size: 140%;
    }
</style>
<script>
    function add_tool() {
        let formx = document.querySelector('template').content.cloneNode(true).children[1];
        Swal.fire({
            title: 'Add tool',
            html: formx,
            customClass: 'mySwalSmallForm',
            showConfirmButton: false
        });
    }
    const view_tool = ()=>{
        let elem = window.event.target.parentNode.parentNode,
            htz = document.querySelector('template').content.children[0].cloneNode(true).outerHTML;
        let jsx = JSON.parse(elem.getAttribute('data-json'));
        htz = htz.replace(/\{\{(.+?)\}\}/g,  (match, tag) => jsx[tag.trim()]);
        Swal.fire({
            html: htz
        });
    };
    const edit_tool = ()=>{
        let elem = window.event.target.parentNode.parentNode,
            htz = document.querySelector('template').content.children[1].cloneNode(true);
        let hin = document.createElement('input');
        hin.type = 'hidden';
        hin.name = 'user_id';
        htz.firstElementChild.firstElementChild.appendChild(hin);
        let jsx = JSON.parse(elem.getAttribute('data-json'));
        let inpts = htz.querySelectorAll('input'),
            selec = htz.querySelectorAll('select'),
            tarea = htz.querySelectorAll('textarea');
        [...inpts, ...selec].forEach(elem=>{
            if(elem.type == 'date' && jsx[elem.name]) jsx[elem.name] = [...jsx[elem.name.trim()]].splice(0,10).join('');
            if(jsx[elem.name]) elem.value = jsx[elem.name];
        });
        [...tarea].forEach(elem=>{
            if(jsx[elem.name]) elem.innerHTML = jsx[elem.name];
        });
        Swal.fire({
            title: `Edit ${jsx.tool_name}`,
            html: htz,
            customClass: 'mySwalSmallForm',
            showConfirmButton: false
        });
        let form = document.querySelector('.mySwalSmallForm form');
        if(form != null){
            form.addEventListener(
                'submit',
                evt=>{
                    evt.preventDefault();
                    let fd = new FormData(form);
                    request_service(
                        'add_tool',
                        response => {
                            console.log(response);
                            let res_json = JSON.parse(response);
                            if(res_json){
                                let jsx = JSON.parse(res_json.response);
                                Swal.fire({
                                    title: jsx.message,
                                    icon: jsx.status
                                })
                                .then(e=>{
                                    window.location.reload();
                                });
                            }
                            else {
                                Swal.fire({
                                    title: 'Malformed response returned',
                                    icon: 'error',
                                    html:response
                                });
                            }
                        },
                        fd
                    );
                }
            );
        }
    };
    const delete_tool = ()=>{
        let elem = window.event.target.parentNode.parentNode;
        let jx = JSON.parse(elem.getAttribute('data-json'));
    
        console.log(jx);
        Swal.fire({
            title: `Delete ${jx.tool_name}?`,
            showCancelButton: true,
            confirmButtonText:'Sure, delete',
            html:"No UNDO remember!"
        })
        .then(response=>{
            if(response.isConfirmed){
                let userdata = new FormData();
                userdata.append('delete_tool', jx.tool_id);
                userdata.append('ajax_request',1);
                ajax(
                window.location.href, 
                response=>{
                    console.log(response);
                    let jsx = JSON.parse(response);
                    if(jsx){
                        Swal.fire({
                            title: jsx.message,
                            icon: jsx.status
                        })
                        .then(e=>{
                            if(jsx.status == 'success'){
                                elem.parentNode.removeChild(elem);
                            }
                        });
                    }
                    else {
                        Swal.fire({
                            title: 'Malformed response returned',
                            icon: 'error',
                            html:response
                        });
                    }
                },
                error=>{
                    console.log(error);
                },
                userdata
                );
            }
        });
    }
</script>