<div class="flex">
    <h1 class="content-small no-pad-top">Staff</h1>
    <div class="shrink">
        <button onclick="add_form('staff')" value="add" data-form-width="wide" class="round">Register staff</button>
    </div>
</div>
<br>
<div>
    <table class="paginate" data-items-per-page="10">
        <thead>
            <tr>
                <th>
                    <input type="checkbox" onclick="upadte_checks()">
                    Particulars
                </th>
                <th>
                    Contacts
                </th>
                <th>
                    Role/Designation
                </th>
                <th>
                    Department
                </th>
                <th>
                    &nbsp;
                </th>
            </tr>
        </thead>
        <tbody>
            <?php foreach($staff as $st){?>
            <tr data-json='<?=json_encode($st)?>'>
                <td class="flex" style="display: flex;">
                    <input type="checkbox" name="staff_id[]" value="<?=$st['user_id']?>" style="max-width:13px">
                    <span style="max-width: 40px;"><img src="<?=user::init()->get_user_avatar($st['user_id'])?>" width="100%"></span>
                    <span>
                        &nbsp;<?=$st['full_name']?><br>
                        &nbsp;<?=$st['user_id']?>
                    </span>
                </td>
                <td>
                    <?=$st['email']?><br>
                    <?=$st['phone']?>
                </td>
                <td>
                    <b><?=$st['role_name']?></b><br>
                    <em><?=$st['designation_name']?></em>
                </td>
                <td>
                    <?=$st['dept_name']?>
                </td>
                <td>
                    <a onclick="view_staff()" data-icon="&#xf06e;"></a>
                    <a onclick="edit_staff()" data-icon="&#xf044;"></a>
                    <a onclick="delete_staff()" data-icon="&#xf2ed;"></a>
                </td>
            </tr>
            <?php }?>
        </tbody>
    </table>
</div>
<style>.swal2-html-container{overflow: visible;}</style>
<template>
    <div class="vspaced" style="text-align: left;">
        <div class="flex white rounded" style="box-shadow: 0 0 4px #999;margin: 4px;margin-top: -4em;">
            <div class="card" style="box-shadow: none;">
                <img src="{{img}}" width="100%">
            </div>
            <div class="content-small">
                <h3 style="padding-bottom: .6em;" class="large-text">{{full_name}}</h3>
                <div><strong>E-mail: </strong>{{email}}</div>
                <div><strong>Phone: </strong>{{phone}}</div>
                <div><strong>Regstration #: </strong>{{registration_number}}</div>
                <div><strong>Employed: </strong>{{date_employed}}</div>
            </div>
        </div>
        <div>
            <div class="flex">
                <div class="content-small">
                    <strong>Residence address</strong>
                    <pre style="font-family: inherit;margin: 0;padding: 0;">{{residence_address}}</pre>
                </div>
                <div>
                    <div class="content-small">
                        <strong>Designation: </strong><br>
                        {{designation_name}}
                    </div>
                    <div class="content-small">
                        <strong>Role: </strong><br>
                        {{role_name}}
                    </div>
                </div>
            </div>
            <div class="flex">
                <div class="content-small">
                    <strong>Work location: </strong><br>
                    {{branch_name}}
                </div>
                <div class="content-small">
                    <strong>Department: </strong><br>
                    {{dept_name}}
                </div>
            </div>
            <div class="flex">
                <div class="content-small">
                    <strong>Bank: </strong><br>
                    {{bank_name}}
                </div>
                <div class="content-small">
                    <strong>Account #: </strong><br>
                    {{bank_account_number}}
                </div>
            </div>
        </div>
    </div>
    <?php include __DIR__.'/add_staff.html';?>
</template>
<style>
    .mySwalForm{
        min-width: 80%;
    }
    .mySwalForm label, .mySwalSmallForm label{
        display: block;
        text-align: left;
        padding-left: 1em;
    }
    .mySwalSmallForm label{
        padding-left: 0;
    }
</style>
<style>
    .contentx{
        padding: 0 1em;
        flex-basis: 100%;
    }
    .contentx > *{
        flex-basis: 100%;
    }
    .contentx input,.contentx select{
        border:1px solid #eee;
        width: calc( 100% - 1.8em );
        margin-top: 6px;
    }
    .contentx label{
        padding-top: .8em;
    }
    .contentx option{
        line-height: 1.5em;
    }
    button{
        text-transform: uppercase;
        white-space: nowrap;
    }
    .flex > *{
        flex-basis: 100%;
    }
    .vspaced *{
        line-height: 1.2;
    }
    .large-text{
        font-size: 140%;
    }
</style>
<script>
    function add_form(name){
        let main_evt = window.event;
        main_evt.preventDefault();
        if(main_evt.target.value == 'add'){
            let wide = main_evt.target.getAttribute('data-form-width');
            let customClass = (wide == 'wide') ? 'mySwalForm' : 'mySwalSmallForm';
            request_service(
                `add_${name}`,
                response => {
                    if(response != ''){
                        let resp = JSON.parse(response);
                        Swal.fire({
                            html:resp.response[0],
                            showConfirmButton:false,
                            customClass: customClass
                        });
                    }
                    else{
                        Swal.fire({
                            html:'Service not available',
                            icon:'info'
                        });
                    }
                    let form = document.querySelector(`.${customClass} form`);
                    if(form != null){
                        form.addEventListener(
                            'submit',
                            evt=>{
                                evt.preventDefault();
                                let fd = new FormData(form);
                                request_service(
                                    `add_${name}`,
                                    response => {
                                        let res_json = JSON.parse(response);
                                        if(res_json){
                                            let jsx = JSON.parse(res_json.response);
                                            Swal.fire({
                                                title: jsx.message,
                                                icon: jsx.status
                                            })
                                            .then(e=>{
                                                window.location.reload();
                                            });
                                        }
                                        else {
                                            Swal.fire({
                                                title: 'Malformed response returned',
                                                icon: 'error',
                                                html:response
                                            });
                                        }
                                    },
                                    fd
                                );
                            }
                        );
                    }
                }
            );
        }
        else return true;
    }
    const view_staff = ()=>{
        let elem = window.event.target.parentNode.parentNode,
            img = elem.querySelector('img');
            htz = document.querySelector('template').content.children[0].cloneNode(true).outerHTML;
        let jsx = JSON.parse(elem.getAttribute('data-json'));
        console.log(jsx);
        //console.log(elem.getAttribute('data-json'));
        htz = htz.replace(/\{\{img\}\}/, img.src); // we expect only one image, no need for greed match
        htz = htz.replace(/\{\{(.+?)\}\}/g,  (match, tag) => jsx[tag.trim()]);
        Swal.fire({
            html: htz
        });
    };
    const edit_staff = ()=>{
        let elem = window.event.target.parentNode.parentNode,
            img = elem.querySelector('img');
            htz = document.querySelector('template').content.children[1].cloneNode(true);
        let hin = document.createElement('input');
        hin.type = 'hidden';
        hin.name = 'user_id';
        htz.firstElementChild.firstElementChild.appendChild(hin);
        let jsx = JSON.parse(elem.getAttribute('data-json'));
        let inpts = htz.querySelectorAll('input'),
            selec = htz.querySelectorAll('select'),
            tarea = htz.querySelectorAll('textarea');
        [...inpts, ...selec].forEach(elem=>{
            if(elem.type == 'date' && jsx[elem.name]) jsx[elem.name] = [...jsx[elem.name.trim()]].splice(0,10).join('');
            if(jsx[elem.name]) elem.value = jsx[elem.name];
        });
        [...tarea].forEach(elem=>{
            if(jsx[elem.name]) elem.innerHTML = jsx[elem.name];
        });
        //htz = htz.replace(/\{\{(.+?)\}\}/g,  (match, tag) => jsx[tag.trim()]);
        Swal.fire({
            html: htz,
            customClass: 'mySwalForm',
            showConfirmButton: false
        });
        let form = document.querySelector('.mySwalForm form');
        if(form != null){
            form.addEventListener(
                'submit',
                evt=>{
                    evt.preventDefault();
                    let fd = new FormData(form);
                    request_service(
                        'add_staff',
                        response => {
                            console.log(response);
                            let res_json = JSON.parse(response);
                            if(res_json){
                                let jsx = JSON.parse(res_json.response);
                                Swal.fire({
                                    title: jsx.message,
                                    icon: jsx.status
                                })
                                .then(e=>{
                                    window.location.reload();
                                });
                            }
                            else {
                                Swal.fire({
                                    title: 'Malformed response returned',
                                    icon: 'error',
                                    html:response
                                });
                            }
                        },
                        fd
                    );
                }
            );
        }
    }
</script>