<div class="flex">
    <h1 class="content-small no-pad-top">Salary slips</h1>
    <div class="shrink" style="white-space: nowrap;text-align: right;">
        <button onclick="create_slip()" value="add" data-form-width="wide" class="round">create slip</button>
    </div>
</div>
<br>
<div>
    <table class="paginate" data-items-per-page="10">
        <thead>
            <tr>
                <th>
                    <input type="checkbox" onclick="upadte_checks()">
                    Employee
                </th>
                <th>
                    Basic salary
                </th>
                <th>
                    Allowance
                </th>
                <th>
                    Bonus
                </th>
                <th>
                    Gross salary
                </th>
                <th>
                    Deductions
                </th>
                <th>
                    Net salary
                </th>
                <th>
                    &nbsp;
                </th>
            </tr>
        </thead>
        <tbody>
            <?php foreach($salary_slip as $ssp){?>
            <tr data-json='<?=json_encode($ssp)?>'>
                <td class="flex" style="display: flex;">
                    <input type="checkbox" name="staff_id[]" value="<?=$ssp['user_id']?>" style="max-width:13px">
                    <span>
                        <sstrong><?=ucwords($ssp['full_name'])?></strong><br>
                        <em><?=$ssp['branch_name']?></em>
                    </span>
                </td>
                <td class="content">
                    <?=number_format($ssp['basic_salary'])?>
                </td>
                <td>
                    <?=number_format($ssp['allowance'])?>
                </td>
                <td>
                    <?=number_format($ssp['bonus'])?>
                </td>
                <td>
                    <?=number_format(array_sum([$ssp['basic_salary'],$ssp['allowance'],$ssp['bonus']]))?>
                </td>
                <td>
                    <?=number_format(array_sum([$ssp['health_insurance_fund'],$ssp['payee'] 
                    ,$ssp['social_security_fund'],$ssp['worker_compasion_fund'],$ssp['education_fund']]))?>
                </td>
                <td>
                    <?=number_format(array_sum([$ssp['basic_salary'],$ssp['allowance'],$ssp['bonus']])-array_sum([$ssp['payee'],
                    $ssp['health_insurance_fund'],$ssp['social_security_fund'],
                    $ssp['worker_compasion_fund'],$ssp['education_fund']]))?>
                </td>
                <td>
                    <a onclick="edit_salary_slip()" data-icon="&#xf044;"></a>
                    <a onclick="delete_salary_slip()" data-icon="&#xf2ed;"></a>
                </td>
            </tr>
            <?php }?>
        </tbody>
    </table>
</div>
<style>.swal2-html-container{overflow: visible;}</style>
<template>
    <?php include __DIR__.'/add_salary_slip.html';?>
</template>
<style>
    .mySwalForm{
        min-width: 80%;
    }
    .mySwalForm label, .mySwalSmallForm label{
        display: block;
        text-align: left;
        padding-left: 1em;
    }
    .mySwalSmallForm label{
        padding-left: 0;
    }
</style>
<style>
    .contentx{
        padding: 0 1em;
        flex-basis: 100%;
    }
    .contentx > *{
        flex-basis: 100%;
    }
    .contentx input,.contentx select{
        border:1px solid #eee;
        width: calc( 100% - 1.8em );
        margin-top: 6px;
    }
    .contentx label{
        padding-top: .8em;
    }
    .contentx option{
        line-height: 1.5em;
    }
    button{
        text-transform: uppercase;
        white-space: nowrap;
    }
    .flex > *{
        flex-basis: 100%;
    }
    .vspaced *{
        line-height: 1.2;
    }
    .large-text{
        font-size: 140%;
    }
</style>
<script>
    const edit_salary_slip = ()=>{
        let elem = window.event.target.parentNode.parentNode,
            img = elem.querySelector('img');
            htz = document.querySelector('template').content.children[0].cloneNode(true);
        let hin = document.createElement('input');
        hin.type = 'hidden';
        hin.name = 'user_id';
        htz.firstElementChild.firstElementChild.appendChild(hin);
        let jsx = JSON.parse(elem.getAttribute('data-json'));
        let inpts = htz.querySelectorAll('input'),
            selec = htz.querySelectorAll('select'),
            tarea = htz.querySelectorAll('textarea');
        [...inpts, ...selec].forEach(elem=>{
            if(elem.type == 'date' && jsx[elem.name]) 
                jsx[elem.name] = [...jsx[elem.name.trim()]].splice(0,10).join('');
            if(jsx[elem.name]) 
                elem.value = jsx[elem.name];
            if(elem.name == 'employee') {
                [...elem.children].forEach(opt=>{
                    if(opt.value != jsx[elem.name]) opt.setAttribute('disabled', true);
                });
            }
        });
        [...tarea].forEach(elem=>{
            if(jsx[elem.name]) elem.innerHTML = jsx[elem.name];
        });
        //htz = htz.replace(/\{\{(.+?)\}\}/g,  (match, tag) => jsx[tag.trim()]);
        Swal.fire({
            html: htz,
            customClass: 'mySwalSmallForm',
            showConfirmButton: false
        });
        let form = document.querySelector('.mySwalSmallForm form');
        if(form != null){
            form.addEventListener(
                'submit',
                evt=>{
                    evt.preventDefault();
                    let fd = new FormData(form);
                    fd.append('slip_id', jsx.slip_id);
                    fd.append('ajax_request', 1);
                    ajax(
                        window.location.href,
                        response=>{
                            let jsx = JSON.parse(response);
                            if(jsx){
                                //let jsx = JSON.parse(res_json.response);
                                Swal.fire({
                                    title: jsx.message,
                                    icon: jsx.status
                                })
                                .then(e=>{
                                    window.location.reload();
                                });
                            }
                            else {
                                Swal.fire({
                                    title: 'Malformed response returned',
                                    icon: 'error',
                                    html:response
                                });
                            }
                        },
                        error=>{
                            console.log(error);
                        },
                        fd
                    );
                }
            );
        }
    };
    const delete_salary_slip = ()=>{
        let elem = window.event.target.parentNode.parentNode;
        let jsx = JSON.parse(elem.getAttribute('data-json'));
        let name = jsx.full_name,
            uid = jsx.user_id;
        Swal.fire({
            title: `Delete ${name}'s slip?`,
            showCancelButton: true,
            confirmButtonText:'Sure, delete',
            html:"No UNDO remember!"
        })
        .then(response=>{
        if(response.isConfirmed){
            let userdata = new FormData();
            userdata.append('delete_slip', uid);
            userdata.append('ajax_request', 1);
            ajax(
            window.location.href, 
            response=>{
                //console.log(response);
                let jsx = JSON.parse(response);
                if(jsx){
                    Swal.fire({
                        title: jsx.message,
                        icon: jsx.status
                    })
                    .then(e=>{
                        if(jsx.status == 'success'){
                             window.location.reload();
                        }
                    });
                }
                else {
                    Swal.fire({
                        title: 'Malformed response returned',
                        icon: 'error',
                        html:response
                    });
                }
            },
            error=>{
                console.log(error);
            },
            userdata
            );
        }
        else{
            Swal.fire({
            title: "Cancel Deletion",
            icon:"error"
            })
        }
        });
    }
    const create_slip = ()=>{
        let cform = document.querySelector('template').content.children[0].cloneNode(true);
        let opts = {
            title: 'Add slip',
            html:cform,
            customClass:'mySwalSmallForm',
            showConfirmButton: false
        }
        Swal.fire(opts);
        let frm = document.querySelector('.mySwalSmallForm form');
        frm.addEventListener('submit', evt=>{
            evt.preventDefault();
            let fd = new FormData(frm);
            fd.append('ajax_request', 1);
            ajax(
                window.location.href,
                success=>{
                    let jsx = JSON.parse(success);
                    Swal.fire({
                        html:jsx.message,
                        icon: jsx.status
                    })
                    .then(val=>{
                        window.location.reload();
                    });
                },
                error=>{
                    console.log(error);
                },
                fd
            );
        });
    }
</script>