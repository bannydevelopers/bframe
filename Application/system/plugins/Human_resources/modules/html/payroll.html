<div class="flex">
  <h1 class="content-small no-pad-top">Payroll</h1>
  <div class="shrink" style="white-space: nowrap;text-align: right;">
      <button onclick="create_payroll()" value="add" data-form-width="wide" class="round">create payroll</button>
  </div>
</div>
<br>      
<div class="flex cards">
<?php foreach($payroll as $pay){?>
    <div>
        <h3><?=$pay['payroll_name']?></h3>
        <div class="content-small">
            <div class="content-small"><?=system::format_time($pay['create_date'])?></div>
            <div style="text-align: right;" class="content-small">
                <a onclick="view_roll()" data-json='<?=$pay['payment_slips']?>' data-icon="&#xf06e;"></a>
                <a onclick="delete_roll(`<?=$pay['payroll_id']?>`)" data-icon="&#xf1f8;"></a>
            </div>
        </div>
    </div>
<?php }?>
</div>
<style>.swal2-html-container{overflow: visible;}</style>
<template>
    <?php include __DIR__.'/add_payroll.html';?>
</template>
<style>
  .mySwalForm{
      min-width: 80%;
  }
  .mySwalForm label, .mySwalSmallForm label{
      display: block;
      text-align: left;
      padding-left: 1em;
  }
  .mySwalSmallForm label{
      padding-left: 0;
  }
</style>
<style>
  .contentx{
      padding: 0 1em;
      flex-basis: 100%;
  }
  .contentx > *{
      flex-basis: 100%;
  }
  .contentx input,.contentx select{
      border:1px solid #eee;
      width: calc( 100% - 1.8em );
      margin-top: 6px;
  }
  .contentx label{
      padding-top: .8em;
  }
  .contentx option{
      line-height: 1.5em;
  }
  button{
      text-transform: uppercase;
      white-space: nowrap;
  }
  .flex > *{
      flex-basis: 100%;
  }
  .vspaced *{
      line-height: 1.2;
  }
  .large-text{
      font-size: 140%;
  }
</style>
<script>
  const edit_payroll = ()=>{
      let elem = window.event.target.parentNode.parentNode,
          img = elem.querySelector('img');
          htz = document.querySelector('template').content.children[1].cloneNode(true);
      let hin = document.createElement('input');
      hin.type = 'hidden';
      hin.name = 'user_id';
      htz.firstElementChild.firstElementChild.appendChild(hin);
      let jsx = JSON.parse(elem.getAttribute('data-json'));
      let inpts = htz.querySelectorAll('input'),
          selec = htz.querySelectorAll('select'),
          tarea = htz.querySelectorAll('textarea');
      [...inpts, ...selec].forEach(elem=>{
          if(elem.type == 'date' && jsx[elem.name]) jsx[elem.name] = [...jsx[elem.name.trim()]].splice(0,10).join('');
          if(jsx[elem.name]) elem.value = jsx[elem.name];
      });
      [...tarea].forEach(elem=>{
          if(jsx[elem.name]) elem.innerHTML = jsx[elem.name];
      });
      //htz = htz.replace(/\{\{(.+?)\}\}/g,  (match, tag) => jsx[tag.trim()]);
      Swal.fire({
          html: htz,
          customClass: 'mySwalForm',
          showConfirmButton: false
      });
      let form = document.querySelector('.mySwalForm form');
      if(form != null){
          form.addEventListener(
              'submit',
              evt=>{
                  evt.preventDefault();
                  let fd = new FormData(form);
                  request_service(
                      'add_payroll',
                      response => {
                          console.log(response);
                          let res_json = JSON.parse(response);
                          if(res_json){
                              let jsx = JSON.parse(res_json.response);
                              Swal.fire({
                                  title: jsx.message,
                                  icon: jsx.status
                              })
                              .then(e=>{
                                  window.location.reload();
                              });
                          }
                          else {
                              Swal.fire({
                                  title: 'Malformed response returned',
                                  icon: 'error',
                                  html:response
                              });
                          }
                      },
                      fd
                  );
              }
          );
      }
  };
  const delete_payroll = ()=>{
      let elem = window.event.target.parentNode.parentNode;
      let jsx = JSON.parse(elem.getAttribute('data-json'));
      let name = jsx.full_name,
          uid = jsx.user_id;
      Swal.fire({
          title: `Delete ${name}?`,
          showCancelButton: true,
          confirmButtonText:'Sure, delete',
          html:"No UNDO remember!"
      })
      .then(response=>{
      if(response.isConfirmed){
          let userdata = new FormData();
          userdata.append('delete_payroll', uid);
          userdata.append('ajax',1);
          ajax(
          window.location.href, 
          response=>{
              let res_json = JSON.parse(response);
              //console.log(response);
              if(res_json){
                  let jsx = res_json.response;
                  Swal.fire({
                      title: jsx.message,
                      icon: jsx.status
                  })
                  .then(e=>{
                      if(jsx.status == 'success'){
                           elem.parentNode.removeChild(elem);
                           createPageButtons(); // create the page buttons initially
                          showPage(currentPage);
                      }
                  });
              }
              else {
                  Swal.fire({
                      title: 'Malformed response returned',
                      icon: 'error',
                      html:response
                  });
              }
          },
          error=>{
              console.log(error);
          },
          userdata
          );
      }
      else{
          Swal.fire({
          title: "Cancel Deletion",
          icon:"error"
          })
      }
      });
  }
  const create_payroll = ()=>{
      let cform = document.querySelector('template').content.children[0].cloneNode(true);
      let opts = {
          title: 'Add payroll',
          html:cform,
          customClass:'mySwalForm'
      }
      Swal.fire(opts);
      let frm = document.querySelector('.mySwalForm form');
      frm.addEventListener('submit', evt=>{
          evt.preventDefault();
          let fd = new FormData(frm);
          fd.append('ajax_request', 1);
          ajax(
              window.location.href,
              success=>{
                  Swal.fire({
                      html:success
                  });
              },
              error=>{
                  console.log(error);
              },
              fd
          );
      });
    }
</script>