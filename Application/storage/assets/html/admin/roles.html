<div id="roles-perms" data-roles='<?=json_encode($permissions)?>'>
    <div class="flex">
        <p class="border-bottom-white" style="padding-bottom: 1em;">
            <em>System permission for roles</em>
        </p>
        <span class="shrink"><button onclick="add_role()">Add role</button></span>
    </div>
    <ul>
    <?php $legends = array_keys($roles);
    foreach($legends as $role){ ?>
        <li style="box-shadow: 0 0 3px #999;margin: 14px;">
            <div style="display: flex;" class="content grey" data-json='<?=json_encode($roles[$role])?>'>
                <b style="flex-grow: 1;"><?=$role?></b>
                <a data-icon="&#xf2ed;" onclick="delete_role('<?=$role?>')" style="margin-right: 1em;"></a>
                <a data-icon="&#xf044;" onclick="edit_permission('<?=$role?>')"></a>
            </div>
            <ul>
                <?php foreach($roles[$role] as $legend=>$permission){?>
                    <li>
                        <br>
                        <div><strong><?=$legend?></strong></div>
                        <div class="flex cards cards-4">
                        <?php foreach($permission as $v){?>
                            <div class="content-small" data-icon="&#xf058;">
                                <?=$v['permission_name']?>
                            </div>
                        <?php }?>
                        </div>
                    </li>
                <?php }?>
            </ul>
        </li>
    <?php }?>
    </ul>
</div>
<style>
    .cards-2 > *{
        min-width: 47%;
        margin: 1.5%;
        text-align: left;
        padding: 0 14px;
    }
    .cards-2 p{
        padding: 0;
        margin: 0;
    }
    .cards-2 > div > label{
        font-weight: bold;
    }
    li .cards{
        justify-content: left;
    }
    li .cards > *{
        border-radius: 3em;
    }
    li .cards .content-small[data-icon]::before{
        color: green;
    }
    .align-left{
        text-align: left;
    }
    .box-shadow{
        box-shadow: 0 0 5px #aaa;
    }
</style>
<script>
    const add_role = ()=>{
        Swal.fire({
            title: 'Adding new role',
            input: 'text',
            inputAttributes: {
                autocapitalize: 'off',
                placeholder:'Role name'
            },
            showCancelButton: true,
            confirmButtonText: 'Save role',
            showLoaderOnConfirm: true,
            preConfirm: (login) => {
                if(login == ''){
                    Swal.showValidationMessage(`Please enter role name`);
                }
                else{
                    return fetch(`${req_uri}/?role_name=${login}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(response.statusText)
                        }
                        return response.json()
                    })
                    .catch(error => {
                        Swal.showValidationMessage(
                        `Request failed: ${error}`
                        )
                    });
                }
            },
            allowOutsideClick: () => !Swal.isLoading()
            }).then((result) => {
            if (result.isConfirmed) {
                if(result.value.status == 'ok'){
                    Swal.fire({
                    title: `Role created successful`,
                    icon: "success",
                    html: result.value.message
                    })
                    .then(whatever=>{
                        window.location.reload();
                    });
                }
                else{
                    Swal.fire({
                    title: `Something is not right`,
                    icon: "error",
                    html: result.value.message
                    });
                }
            }
        });
    };
    const edit_permission = (role)=>{
        let tpljson = JSON.parse(document.getElementById('roles-perms').getAttribute('data-roles'));
        let tpl = '<form method="post" name="perms-form" class="content-small">'
                    +`<input type="hidden" name="role_perm" value="${role}" placeholder="Role name">`
                    +'<div>';
        let perms = window.event.target.parentNode.nextElementSibling.querySelectorAll('.content-small');
        let perm_list = [];
        [...perms].forEach(elem=>{
            perm_list.push(elem.innerText.trim());
        });
        for(legend in tpljson){
            let id = (legend+' ').replace(' ', '_');
            tpl += `<br><h3 class="content-small align-left grey round box-shadow">`
                + `&nbsp;<input type="checkbox" onchange="update_checks()" id="${id}">`
                + `<label for="${id}" style="padding:0">&nbsp;${legend}</label></h3>`
                + `<div class="flex cards">`;
            tpljson[legend].forEach(perm => {
                let check = '';
                if(perm_list.includes(perm.permission_name.trim())) check = ' checked';
                tpl += '<p style="white-space: nowrap;box-shadow:none;">'
                        +`<input type="checkbox" name="permission[]" id="${perm.permission_name}" value="${perm.permission_id}"${check}>`
                        +`<label for="${perm.permission_name}" title="${perm.permission_name}" style="padding:0 6px">${perm.permission_name}</label>`
                        +'</p>';
            });
            tpl += '</div>';
        }
        tpl += '</div></form>';
        Swal.fire({
            title:`Permissions of ${role}<hr>`,
            showCancelButton: true,
            confirmButtonText: 'Update permissions',
            html: tpl
        })
        .then(result=>{
            if(result.isConfirmed){
                let data = new FormData(document.querySelector('form[name=perms-form]'));
                ajax(
                    req_uri,
                    response=>{
                        Swal.fire({
                            icon:"success",
                            title: "That's how it was done!",
                            html: response
                        })
                        .then(response=>{window.location.reload()});
                    },
                    error=>{
                        Swal.fire({
                            icon:"error",
                            title:"Something gone not our way",
                            html: error
                        });
                    },
                    data
                )
            }
        });
    }
    const delete_role = (role)=>{
        Swal.fire({
            title: `About to delete the role '${role}'`,
            icon: "question",
            html: "No UNDO then, continue?",
            showCancelButton: true,
            confirmButtonText: 'Sure, delete'
        })
        .then(result=>{
            if(result.isConfirmed){
                let data = new FormData();
                data.append('del_role', role);
                ajax(
                    req_uri,
                    response=>{
                        Swal.fire({
                            icon:"success",
                            title: "That's how it was done!",
                            html: response
                        })
                        .then(response=>{window.location.reload()});
                    },
                    error=>{
                        Swal.fire({
                            icon:"error",
                            title:"Something gone not our way",
                            html: error
                        });
                    },
                    data
                )
            }
        });
    }
    const update_checks = ()=>{

    }
</script>