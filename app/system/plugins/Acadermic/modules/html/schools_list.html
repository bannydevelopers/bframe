<?php if(isset($msg)){?>
<p class="msg content rounded box-shadow" onclick="this.parentNode.removeChild(this)"><?=$msg?></p>
<?php }?>
<h1 class="flex">
    <span>Schools registered</span>
    <button class="flex-shrink round" onclick="add_school()">Add school</button>
</h1>
<div style="padding-top: 1em;">
    <table>
        <thead>
            <tr>
                <th>#</th>
                <th>Name</th>
                <th>Registration</th>
                <th>Plan</th>
                <th>Phone</th>
                <th>E-mail</th>
                <th>Create date</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
        <?php 
            $i = 0; 
            foreach($schools as $school){
            $xtraz = json_decode($school['page_extras'], true);
            $school['page_extras'] = $xtraz;
            $key = array_search($xtraz['subscription_package'], array_column($subs, 'sub_id'));
        ?>
            <tr data-extras='<?=json_encode($school)?>'>
                <td><?=++$i?></td>
                <td><?=$school['page_name']?></td>
                <td><?=$xtraz['registration_number']?></td>
                <td><?=$subs[$key]['sub_name']?></td>
                <td><?=$xtraz['phone']?></td>
                <td><?=$xtraz['email']?></td>
                <td><?=system::format_time($school['create_date'], 3)?></td>
                <td>
                    <a data-icon="&#xf06e;" onclick="view_school()"></a>
                    <a data-icon="&#xf044;" onclick="edit_school()"></a>
                    <a data-icon="&#xf2ed;" onclick="delete_school()"></a>
                </td>
            </tr>
            <?php }?>
        </tbody>
    </table>
</div>
<template id="school_add_form">
    <?php include(__DIR__.'/schools_list_add.html')?>
</template>
<style>
    button{
        text-transform: uppercase;
    }
    .wideSwal{
        min-width: 600px;
    }
    .wideSwal label, .wideSwal h3{
        display: block;
        text-align: left;
        padding-top: 1em;
    }
    .msg{
        background-color: #f0e6d2;
        color: #bd7f03;
    }
    .x-pad > div > *{
        display: block;
        padding: .6em;
    }
    .x-pad > div > *:first-child{
        padding-bottom: 0;
        text-transform: uppercase;
        white-space: nowrap;
        font-size: 80%;
    }
</style>
<script>
    const add_school = ()=>{
        let fom = document.getElementById('school_add_form').content.cloneNode(true).children[0];
        Swal.fire({
            title:'School registration',
            html:fom,
            customClass:'wideSwal',
            showConfirmButton:false
        });
        let subform = document.querySelector('.wideSwal form');
        subform.addEventListener('submit', evt=>{
            evt.preventDefault();
            let fd = new FormData(subform);
            fd.append('ajax_request', 1);
            ajax(
                window.location.href,
                response=>{
                    console.log(response);
                    if(response == 'success') htx = 'School created successful!';
                    else htx = 'School create failed!';
                    Swal.fire({
                        icon:response,
                        title: htx
                    })
                    .then(any=>{
                        window.location = window.location.href;
                    });
                },
                error=>{
                    console.log(error);
                },
                fd
            );
        });
    }
    const view_school = ()=>{
        let elem = window.event.target;
        let _json = JSON.parse(elem.parentNode.parentNode.getAttribute('data-extras'));

        let htz = '<div class="flex cards x-pad" style="text-align:left">';
            console.log(_json.page_extras);
        /*[..._json.page_extras].forEach((item, index)=>{
            htz += `<div><b>${index}</b><span>${item}</span></div>`;
        });*/
        for(index in _json.page_extras){
            let val = `${index}`.replace(/_/g,' ');
            htz += `<div style="min-width:45%"><b>${val}</b><span>${_json.page_extras[index]}</span></div>`;
        }
        htz += '</div>';
        Swal.fire({
            title: _json.page_name,
            html: htz,
            customClass: 'mySwal'
        });
    }
    const delete_school = ()=>{
        let jsonx = JSON.parse(window.event.target.parentNode.parentNode.getAttribute('data-extras'));
        Swal.fire({
            title: `Surely delete '${jsonx.page_name}'?`,
            html: '<em>Be reminded: No UNDO once deleted!</em>',
            showCancelButton:true,
            confirmButtonText:'Sure, delete'
        })
        .then(prompt=>{
            if(prompt.isConfirmed){
                let fd = new FormData(), htx;
                fd.append('delete_school', jsonx.page_id);
                fd.append('ajax_request', 1);
                ajax(
                    window.location.href,
                    response=>{
                        if(response == 'success') htx = 'Package deleted successful!';
                        else htx = 'Package deletion failed!';
                        Swal.fire({
                            icon:response,
                            title: htx
                        })
                        .then(any=>{
                            window.location.reload();
                        });
                    },
                    error=>{
                        console.log(error);
                    },
                    fd
                );
            }
        });
    }
</script>