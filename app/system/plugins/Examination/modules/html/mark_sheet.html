<?php if(isset($msg)){?>
    <p class="msg content rounded box-shadow" onclick="this.parentNode.removeChild(this)"><?=$msg?></p>
    <?php }?>
    <h1 class="content-small flex">
        <span>Exams mark sheet</span>
        <!--button class="flex-shrink" onclick="create_mark_sheet()">Record results</button-->
    </h1>
    <div class="content-small">
        <div class="flex content-small box-shadow">
            <select onchange="update_mark_sheet(true)">
                <option value="">Exam...</option>
                <?php foreach($exams as $ex){?>
                <option value="<?=$ex['schedule_id']?>">
                    <?=$ex['exam_name']?>,
                    <?=$ex['subject_name']?>,
                    <?=$ex['class_name']?>
                    (<?=$ex['section_name']?>)
                    <?=system::format_time($ex['schedule_date'],3)?>
                </option>
                <?php }?>
            </select>
            <button type="button" onclick="update_mark_sheet()" class="flex-shrink">VIEW</button>
        </div>
    </div>
    <div class="content-small">
        <div class="white view-pane">
            <div style="text-align: center;">
                <span style="font-size: 18vw;margin-left: .3em;" data-icon="&#xf071;"></span><br>
                <em class="content">Make selection to continue</em>
            </div>
        </div>
    </div>
    <template>
        <!--?php include __DIR__.'/create_mark_sheet.html';?-->
    </template>
    <script>
        var warn_user = false,
            warn_elem = null;
        const update_warning = activate=>{
            warn_user = activate;
            warn_elem = window.event.target;
        };
        const create_mark_sheet = ()=>{
            let htf = document.querySelector('template').content.cloneNode(true);
            Swal.fire({
                title: 'Create mark sheet',
                html: htf.children[0],
                customClass: 'mySwal',
                showConfirmButton:false
            });
            document.querySelector('.mySwal form').addEventListener('submit', evt=>{
                evt.preventDefault();
                let fmx = new FormData(evt.target);
                ajax(
                    window.location.href,
                    response=>{
                        Swal.fire({
                            html:response
                        });
                    },
                    error=>{
                        //
                    },
                    fmx
                );
            });
        };
        const list_students = ()=>{
            let elem = window.event.target;
            if(elem.value == '') return;
            let fd = new FormData();
            fd.append('list_students', elem.value);
            ajax(
                window.location.href,
                response=>{
                    elem.nextElementSibling.innerHTML = response;
                },
                error=>{
                    console.log(error);
                },
                fd
            );
        };
        const ajax_send = ()=>{
            let evt = window.event;
            evt.preventDefault();
            update_warning(false);
            let fmx = new FormData(evt.target);
            ajax(
                window.location.href,
                response =>{
                    Swal.fire({
                        html: response,
                        icon:'info'
                    });
                },
                error=>{
                    Swal.fire({
                        icon: 'info',
                        html: error
                    });
                },
                fmx
            );
        };
        let bak, timer_run;
        const update_mark_sheet = delay => {
            let vp = document.querySelector('.view-pane'),
                optval = window.event.target.parentNode.children[0];
            if(!bak) bak = vp.innerHTML;
            if(timer_run) clearTimeout(timer_run);
            if(optval.value == '') {
                //vp.innerHTML = bak;
                return;
            }
            function exec_update(){
                vp.innerHTML = '<h1 class="content center">Loading...</h1>';
                let fd = new FormData();
                fd.append('schedule_attendee', optval.value);
                ajax(
                    window.location.href,
                    response=>{
                        vp.innerHTML = response;
                    },
                    error=>{
                        Swal.fire({
                            icon:'info',
                            html: error
                        });
                    },
                    fd
                );
            }
            /*if(delay){
                timer_run = setTimeout(exec_update, 2000);
            }
            else */exec_update();
        };
        window.onbeforeunload = function (evt) {
            if (warn_user) {
                if(warn_elem){
                    warn_elem.style.background = 'red';
                }
                return "If you reload this page, your changes will be lost! Please cancel and save";
            }
        }
    </script>