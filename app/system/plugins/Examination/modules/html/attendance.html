<?php if(isset($msg)){?>
<p class="msg content rounded box-shadow" onclick="this.parentNode.removeChild(this)"><?=$msg?></p>
<?php }?>
<h1 class="content-small flex">
    <span>Exam attendance</span>
    <button class="flex-shrink" onclick="create_attendance()">Create attendance</button>
</h1>
<div class="content-small">
    <div class="flex content-small box-shadow">
        <select onchange="update_attendance(true)">
            <option value="">Exam...</option>
            <?php foreach($exams as $ex){?>
            <option value="<?=$ex['schedule_id']?>">
                <?=$ex['exam_name']?>,
                <?=$ex['subject_name']?>,
                <?=$ex['class_name']?>
                (<?=$ex['section_name']?>)
                <?=system::format_time($ex['schedule_date'],3)?>
            </option>
            <?php }?>
        </select>
        <button type="button" onclick="update_attendance()" class="flex-shrink">VIEW</button>
    </div>
</div>
<div class="content-small">
    <div class="white view-pane">
        <div style="text-align: center;">
            <span style="font-size: 18vw;margin-left: .3em;" data-icon="&#xf06a;"></span><br>
            <em class="content">Make selection to continue</em>
        </div>
    </div>
</div>
<template>
    <?php include __DIR__.'/create_attendance.html';?>
</template>
<script>
    const create_attendance = ()=>{
        let htf = document.querySelector('template').content.cloneNode(true);
        Swal.fire({
            title: 'Create attendance',
            html: htf.children[0],
            customClass: 'mySwal',
            showConfirmButton:false
        });
        document.querySelector('.mySwal form').addEventListener('submit', evt=>{
            evt.preventDefault();
            let fmx = new FormData(evt.target);
            ajax(
                window.location.href,
                response=>{
                    Swal.fire({
                        html:response
                    });
                },
                error=>{
                    //
                },
                fmx
            );
        });
    };
    const list_students = ()=>{
        let elem = window.event.target;
        if(elem.value == '') return;
        let fd = new FormData();
        fd.append('list_students', elem.value);
        ajax(
            window.location.href,
            response=>{
                elem.nextElementSibling.innerHTML = response;
            },
            error=>{
                console.log(error);
            },
            fd
        );
    };
    const add_to_attendance = (name, stid, sid)=>{
        Swal.fire({
            icon: 'question',
            html: `Add <strong>${name}</strong> to attendance?`,
            customClass:'mySwal',
            showCancelButton:true
        })
        .then(prompt=>{
            if(prompt.isConfirmed){
                //console.log(stid,sid);
                let fd = new FormData();
                fd.append('add_to_attendance',1);
                fd.append('student_id', stid);
                fd.append('exam_id', sid);
                fd.append('ajax_request',1 );
                ajax(
                    window.location.href,
                    response=>{
                        let jsx = JSON.parse(response);
                        Swal.fire({
                            icon: 'info',
                            html: jsx.msg
                        })
                        .then(any=>{
                            let vp = document.querySelector('.view-pane');
                            vp.innerHTML = jsx.html;
                            document.getElementById('absent_st').click();
                            //window.location.reload();
                        });
                    },
                    error=>{
                        Swal.fire({
                            icon:'info',
                            html:error
                        });
                    },
                    fd
                );
            }
        });
    };
    const delete_from_attendance = (name, stid, sid)=>{
        Swal.fire({
            icon: 'question',
            html: `Remove <strong>${name}</strong> from attendance?`,
            customClass:'mySwal',
            showCancelButton:true
        })
        .then(prompt=>{
            if(prompt.isConfirmed){
                //console.log(stid,sid);
                let fd = new FormData();
                fd.append('remove_from_attendance',1);
                fd.append('student_id', stid);
                fd.append('exam_id', sid);
                fd.append('ajax_request',1 );
                ajax(
                    window.location.href,
                    response=>{
                        let jsx = JSON.parse(response);
                        Swal.fire({
                            icon: 'info',
                            html: jsx.msg
                        })
                        .then(any=>{
                            let vp = document.querySelector('.view-pane');
                            vp.innerHTML = jsx.html;
                            //window.location.reload();
                        });
                    },
                    error=>{
                        Swal.fire({
                            icon:'info',
                            html:error
                        });
                    },
                    fd
                );
            }
        });
    };
</script>
<script>
    let bak, timer_run;
    const update_attendance = delay => {
        let vp = document.querySelector('.view-pane'),
            optval = window.event.target.parentNode.children[0];
        if(!bak) bak = vp.innerHTML;
        if(timer_run) clearTimeout(timer_run);
        if(optval.value == '') {
            //vp.innerHTML = bak;
            return;
        }
        function exec_update(){
            vp.innerHTML = '<h1 class="content center">Loading...</h1>';
            let fd = new FormData();
            fd.append('schedule_attendee', optval.value);
            ajax(
                window.location.href,
                response=>{
                    vp.innerHTML = response;
                },
                error=>{
                    Swal.fire({
                        icon:'info',
                        html: error
                    });
                },
                fd
            );
        }
        /*if(delay){
            timer_run = setTimeout(exec_update, 2000);
        }
        else */exec_update();
    };
</script>